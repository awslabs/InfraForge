apiVersion: v1
kind: Pod
metadata:
  name: s3-test-pod
  namespace: default
  labels:
    app: s3-mountpoint-test
    purpose: testing
spec:
  containers:
  - name: test-container
    image: amazonlinux:2023
    command: ["/bin/bash"]
    args: ["-c", "while true; do sleep 3600; done"]  # 1å°æ—¶çš„sleepï¼Œç»™è¶³å¤Ÿæ—¶é—´æµ‹è¯•
    volumeMounts:
    - name: s3-volume
      mountPath: /mnt/s3
      readOnly: false  # å…è®¸è¯»å†™æ“ä½œ
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi
  volumes:
  - name: s3-volume
    persistentVolumeClaim:
      claimName: s3-sc-pvc
  restartPolicy: Never
  # ç¡®ä¿è°ƒåº¦åˆ°CPUèŠ‚ç‚¹æ± 
  nodeSelector:
    karpenter.sh/nodepool: karpenter-cpu
  # å®¹å¿åº¦è®¾ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
  tolerations: []
---
# å¯é€‰ï¼šåˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•çš„Job
apiVersion: batch/v1
kind: Job
metadata:
  name: s3-mountpoint-test-job
  namespace: default
spec:
  template:
    metadata:
      labels:
        app: s3-mountpoint-test-job
    spec:
      containers:
      - name: test-container
        image: amazonlinux:2023
        command: ["/bin/bash"]
        args:
        - "-c"
        - |
          echo "ğŸš€ å¼€å§‹S3 Mountpointæµ‹è¯•..."
          
          echo "ğŸ“ æ£€æŸ¥æŒ‚è½½ç‚¹:"
          df -h | grep s3
          
          echo "ğŸ“Š ç»Ÿè®¡S3å†…å®¹:"
          echo "æ€»æ–‡ä»¶æ•°: $(ls -1 /mnt/s3/ | wc -l)"
          
          echo "ğŸ“– æµ‹è¯•æ–‡ä»¶è¯»å–:"
          if [ -f '/mnt/s3/test-file.txt' ]; then
            echo "è¯»å–ç°æœ‰æ–‡ä»¶:"
            head -3 /mnt/s3/test-file.txt
          fi
          
          echo "ğŸ’¾ æµ‹è¯•æ–‡ä»¶å†™å…¥:"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TEST_FILE="/mnt/s3/k8s-job-test-$TIMESTAMP.txt"
          echo "Kubernetes Job S3 Test - $TIMESTAMP" > "$TEST_FILE" 2>/dev/null
          if [ $? -eq 0 ]; then
            echo "âœ… æ–‡ä»¶å†™å…¥æˆåŠŸ: $TEST_FILE"
            cat "$TEST_FILE"
          else
            echo "âŒ æ–‡ä»¶å†™å…¥å¤±è´¥"
          fi
          
          echo "ğŸ“ˆ æ€§èƒ½æµ‹è¯•:"
          echo "ç›®å½•åˆ—è¡¨æ€§èƒ½:"
          time ls -la /mnt/s3/ > /dev/null 2>&1
          
          echo "ğŸ‰ æµ‹è¯•å®Œæˆ!"
        volumeMounts:
        - name: s3-volume
          mountPath: /mnt/s3
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
      volumes:
      - name: s3-volume
        persistentVolumeClaim:
          claimName: s3-sc-pvc
      restartPolicy: Never
      nodeSelector:
        karpenter.sh/nodepool: karpenter-cpu
  backoffLimit: 3
