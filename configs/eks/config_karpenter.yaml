global:
  stackName: aws-infra-forge
  dualStack: true
  description: 'Advanced EKS with Karpenter Autoscaling Solution: Delivers a production-ready Kubernetes environment with intelligent, just-in-time node provisioning for optimal resource utilization and cost efficiency. The solution features heterogeneous node pools supporting multiple instance types for workload-specific optimization. Includes comprehensive OS support with Bottlerocket (default), Amazon Linux, and Windows options. Specialized node pools are pre-configured for various compute workloads: standard (CPU-optimized), NVIDIA GPU acceleration, and AWS Neuron (for ML/AI workloads). This solution automatically integrates with EFS or FSx for Lustre for persistent storage needs. For training workloads, it''s recommended to avoid using the modern training operator due to compatibility issues, though the training operator version can be freely specified. The deployment is fully customizable with configurable versions for EKS, Karpenter, and the NVIDIA device plugin, enabling precise control over the infrastructure stack.'
enabledForges:
  - efs
  - eks
forges:
  vpc:
    defaults:
      id: vpc
      type: VPC
      cidrBlock: 10.69.0.0/16
      natGatewayPerAZ: false
  efs:
    defaults:
      security: isolated
      subnet: isolated
      type: EFS
    instances:
      - id: efs
  lustre:
    defaults:
      dataCompressionType: lz4
      deploymentType: scratch2
      fileSystemVersion: "2.15"
      storageType: ssd
      perUnitStorageThroughput: 250
      removalPolicy: destory
      azIndex: 1
      security: isolated
      storageCapacityGiB: 1200
      subnet: isolated
      type: LUSTRE
    instances:
      - id: fsx
  eks:
    defaults:
      type: EKS
      security: private
      subnet: private
      instanceTypes: m7g.xlarge,m7g.2xlarge
      osType: bottlerocket
      windowsType: core_2022
      keyName: aws-infra-forge
      gpuType: standard
      osArch: arm64
      minSize: 2
      maxSize: 5
      diskSize: 30
      eksVersion: "1.33"
      adminUsers: ""
      controlPlaneAzIndices: 1,2
      commentNvidiaPluginVersion: === https://catalog.ngc.nvidia.com/orgs/nvidia/containers/k8s-device-plugin/tags ===
      nvidiaPluginVersion: 0.18.1
      commentNeuronDevicePluginVersion: === https://gallery.ecr.aws/neuron/neuron-device-plugin ===
      neuronDevicePluginVersion: 2.28.27.0
      commentEfaPluginVersion: === https://artifacthub.io/packages/helm/aws/aws-efa-k8s-device-plugin ===
      efaPluginVersion: 0.5.19
      commentPodIdentityAgentVersion: === https://gallery.ecr.aws/eks/eks-pod-identity-agent ===
      podIdentityAgentVersion: latest
      commentAwsLoadBalancerControllerVersion: === https://artifacthub.io/packages/helm/aws/aws-load-balancer-controller ===
      awsLoadBalancerControllerVersion: 1.16.0
      commentCertManagerVersion: === https://artifacthub.io/packages/helm/cert-manager/cert-manager ===
      certManagerVersion: 1.19.1
      commentMetricsServerVersion: === https://github.com/kubernetes-sigs/metrics-server/releases ===
      metricsServerVersion: 3.13.0
      commentMountpointS3CsiDriverVersion: === https://github.com/awslabs/mountpoint-s3-csi-driver/releases ===
      mountpointS3CsiDriverVersion: 2.0.0
      s3BucketName: aws-infra-forge
      deployCsiDriver: false
      createStorageClass: false
      storageClassName: sc
      createStaticPV: false
      createDefaultPVC: false
      defaultPVCNamespace: default
      deployTrainingOperator: false
      commentTrainingOperatorVersion: === https://github.com/kubeflow/trainer/tags ===
      trainingOperatorVersion: 1.9.3
      commentMlflowVersion: === https://artifacthub.io/packages/helm/community-charts/mlflow ===
      mlflowVersion: 1.8.0
      enableHyperPodComponents: false
      useModernTrainingOperator: false
      commentKarpenterVersion: === https://karpenter.sh ===
      karpenterVersion: 1.7.1
      karpenterNodePools: cpu,gpu,neuron
      karpenterOsType: linux
      commentCpu: === 通用 CPU 节点池 ===
      karpenterCpuInstanceFamilies: ""
      karpenterCpuInstanceCategories: c,m,r
      karpenterCpuInstanceGenerations: 5,6,7
      karpenterCpuInstanceTypes: ""
      karpenterCpuCapacityTypes: spot,on-demand
      karpenterCpuArchitectures: amd64,arm64
      karpenterCpuDiskType: gp3
      karpenterCpuDiskSize: 100
      karpenterCpuDiskIops: 3000
      karpenterCpuDiskThroughput: 125
      karpenterCpuUseInstanceStore: true
      karpenterCpuLabels: workload-type=general
      commentGpu: === GPU 训练节点池 ===
      karpenterGpuInstanceFamilies: ""
      karpenterGpuInstanceCategories: ""
      karpenterGpuInstanceGenerations: ""
      karpenterGpuInstanceTypes: g5.xlarge,g5.2xlarge,g4dn.xlarge
      karpenterGpuCapacityTypes: spot,on-demand
      karpenterGpuArchitectures: amd64,arm64
      karpenterGpuDiskType: gp3
      karpenterGpuDiskSize: 200
      karpenterGpuDiskIops: 8000
      karpenterGpuDiskThroughput: 500
      karpenterGpuUseInstanceStore: true
      karpenterGpuTaints: nvidia.com/gpu=true:NoSchedule
      karpenterGpuLabels: accelerator=nvidia,workload-type=training
      commentNeuron: === Neuron 推理节点池 ===
      karpenterNeuronInstanceFamilies: ""
      karpenterNeuronInstanceCategories: ""
      karpenterNeuronInstanceGenerations: ""
      karpenterNeuronInstanceTypes: inf1.xlarge,inf2.xlarge
      karpenterNeuronCapacityTypes: spot,on-demand
      karpenterNeuronArchitectures: amd64
      karpenterNeuronDiskType: gp3
      karpenterNeuronDiskSize: 150
      karpenterNeuronDiskIops: 5000
      karpenterNeuronDiskThroughput: 500
      karpenterNeuronUseInstanceStore: true
      karpenterNeuronTaints: aws.amazon.com/neuron=true:NoSchedule
      karpenterNeuronLabels: accelerator=neuron,workload-type=inference
    instances:
      - id: eks
        dependsOn: EFS:efs
        deployCsiDriver: true
        createStorageClass: true
        createStaticPV: true
        createDefaultPVC: true
